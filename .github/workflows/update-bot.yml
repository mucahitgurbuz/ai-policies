name: AI Policies Update Bot

on:
  repository_dispatch:
    types: [ai-policies-release]
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      repositories:
        description: 'Comma-separated list of repositories to update (owner/repo format)'
        required: false
        type: string
      organization:
        description: 'GitHub organization to search for repositories'
        required: false
        type: string
      dry-run:
        description: 'Run in dry-run mode (no actual changes)'
        required: false
        type: boolean
        default: false

jobs:
  update-repositories:
    name: Update AI Policies in Repositories
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run AI Policies Update Bot
        uses: ./packages/update-bot-action
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repositories: ${{ github.event.inputs.repositories || '' }}
          organization: ${{ github.event.inputs.organization || 'your-org' }}
          branch-name: 'ai-policies/auto-update'
          commit-message: 'chore: update AI Policies configurations'
          pr-title: 'ðŸ¤– Update AI Policies configurations'
          pr-body: |
            ## ðŸ¤– Automated AI Policies Update

            This pull request was automatically generated to update your AI Policies configurations to the latest versions.

            ### What's Updated
            - Policy packages updated to their latest compatible versions
            - IDE configuration files regenerated with new rules
            - Any new security or best practice guidelines applied

            ### Review Guidelines
            - âœ… Review the changes to `.cursorrules` and `.copilot/instructions.md`
            - âœ… Ensure the updated rules align with your team's preferences
            - âœ… Test with your AI assistant to verify the new configurations work as expected

            ### Need Help?
            - ðŸ“– [AI Policies Documentation](https://github.com/ai-policies/ai-policies)
            - ðŸ› [Report Issues](https://github.com/ai-policies/ai-policies/issues)

            ---
            *Generated by [AI Policies Update Bot](https://github.com/ai-policies/ai-policies) on {{ date }}*
          auto-merge: false
          reviewers: ''
          team-reviewers: ''
          labels: 'dependencies,ai-policies,automated'
          dry-run: ${{ github.event.inputs.dry-run || false }}

      - name: Report Results
        if: always()
        run: |
          echo "### AI Policies Update Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repositories Updated**: ${{ steps.update-bot.outputs.repositories-updated }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pull Requests Created**: ${{ steps.update-bot.outputs.pull-requests-created }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repositories Skipped**: ${{ steps.update-bot.outputs.repositories-skipped }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Errors**: ${{ steps.update-bot.outputs.errors }}" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.update-bot.outputs.pull-requests-created }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Created Pull Requests" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.update-bot.outputs.pull-requests-created }}" | while read -r url; do
              echo "- [$url]($url)" >> $GITHUB_STEP_SUMMARY
            done
          fi
